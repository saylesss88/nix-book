// src/bin/mdbook-rss.rs
use mdbook_rss::build_feed;
use serde_json::Value;
use std::fs;
use std::io::Read;
use std::path::PathBuf;

fn main() {
    let args: Vec<String> = std::env::args().collect();
    if args.get(1).map(|s| s.as_str()) == Some("supports") {
        println!("true");
        return;
    }

    let mut input = String::new();
    std::io::stdin()
        .read_to_string(&mut input)
        .expect("Failed to read stdin");

    let input_array: Vec<Value> = serde_json::from_str(&input).expect("Invalid JSON from mdBook");

    if input_array.len() < 2 {
        eprintln!("ERROR: mdBook sent less than 2 JSON objects");
        std::process::exit(1);
    }

    let context = &input_array[0];
    let book = &input_array[1]; // THIS IS THE REAL BOOK!

    let root = context
        .pointer("/root")
        .and_then(|v| v.as_str())
        .unwrap_or(".");

    let src_dir = PathBuf::from(root).join("src");

    let site_url = context
        .pointer("/config/output/html/site-url")
        .and_then(|v| v.as_str())
        .map(str::trim)
        .filter(|s| !s.is_empty())
        .unwrap_or("https://example.com/")
        .trim_end_matches('/')
        .to_string();

    let feed_title = context
        .pointer("/config/book/title")
        .and_then(|v| v.as_str())
        .map(str::trim)
        .filter(|s| !s.is_empty())
        .unwrap_or("My mdBook");

    let feed_description = context
        .pointer("/config/book/description")
        .and_then(|v| v.as_str())
        .unwrap_or("An mdBook-generated site");

    eprintln!("Root: {root}");
    eprintln!("Site URL: {site_url}");
    eprintln!("Title: {feed_title}");

    let channel = build_feed(&src_dir, feed_title, &site_url, feed_description)
        .expect("Failed to generate RSS feed");

    let book_dir = PathBuf::from(root).join("book");
    fs::create_dir_all(&book_dir).unwrap();
    let rss_path = book_dir.join("rss.xml");
    fs::write(&rss_path, channel.to_string()).unwrap();
    eprintln!("RSS feed written to {}", rss_path.display());

    // ECHO BACK THE SECOND ELEMENT â€” THE ACTUAL BOOK
    println!("{}", serde_json::to_string(book).unwrap());
}
