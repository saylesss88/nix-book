
name: Deploy mdBook to GitHub Pages
on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Preserves git history if needed for your book

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1  # Use v1 for stability; v2 is experimental
        with:
          mdbook-version: "latest"
          # mdbook-version: "0.4.40"  # Pin to stable version; update as needed

      - name: Install mdBook preprocessors
        run: |
          # Install mdbook-toc if used in book.toml
          cargo install mdbook-toc
          # Install your RSS preprocessor (pinned to published version)
          cargo install mdbook-rss-feed --version 0.1.0
          # cargo install mdbook-yml-header
          # Ensure Cargo bin is in PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Verify mdBook preprocessors
        run: |
          which mdbook-toc || echo "mdbook-toc not found"
          which mdbook-rss-feed || echo "mdbook-rss-feed not found"
          # which mdbook-yml-header || echo "mdbook-yml-header not found"
          # Test functionality via build preview instead of --help
          mdbook build --quiet | grep -q "RSS feed written" || echo "RSS generation check failed"

      - name: Build mdBook
        run: mdbook build  # Preprocessors (RSS and TOC) run automatically here via book.toml

      - name: Verify RSS Output
        run: |
          # Check if RSS was generated by preprocessor
          ls -la src/rss.xml  # Should exist with ~17KB size from your local run
          head -20 src/rss.xml  # Preview: Look for <generator>mdbook-rss-feed 0.1.0</generator>
          # Optionally copy to book/ if needed for direct access on site
          cp src/rss.xml book/rss.xml

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'  # Only on main pushes
        with:
          personal_token: ${{ secrets.PAT_TOKEN }}  # Required for external repo
          publish_dir: ./book
          publish_branch: gh-pages  # Standard branch for Pages; change to 'main' if your repo uses it
          external_repository: saylesss88/saylesss88.github.io
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy nix-book from main'
